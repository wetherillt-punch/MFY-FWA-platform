import { DMEAnomaly } from '../dme-types';

export function detectDenialPatternExploits(claims: any[], providerId: string): DMEAnomaly | null {
  const providerClaims = claims.filter(c => c.provider_id === providerId);
  
  if (providerClaims.length < 30) return null;
  
  // Look for denial → rebill patterns
  const denialCodes = /^CARC[ -]?(50|97|96|119)$|^denial$/i;
  const deniedClaims = providerClaims.filter(c => 
    denialCodes.test(String(c.denial_code || '')) || 
    String(c.paid_status || '').toLowerCase().includes('deni')
  );
  
  if (deniedClaims.length < 5) return null;
  
  // Group by member + code to find rebill chains
  const rebillChains: any[] = [];
  
  deniedClaims.forEach(deniedClaim => {
    const matchKey = `${deniedClaim.member_id}_${deniedClaim.cpt_hcpcs}`;
    
    // Look for resubmission within 14 days
    const rebills = providerClaims.filter(c => {
      if (c.claim_id === deniedClaim.claim_id) return false;
      if (c.member_id !== deniedClaim.member_id) return false;
      if (c.cpt_hcpcs !== deniedClaim.cpt_hcpcs) return false;
      
      const deniedDate = new Date(deniedClaim.service_date);
      const rebillDate = new Date(c.service_date);
      const daysDiff = Math.abs((rebillDate.getTime() - deniedDate.getTime()) / (1000 * 60 * 60 * 24));
      
      return daysDiff <= 14 && String(c.paid_status || '').toLowerCase().includes('paid');
    });
    
    if (rebills.length > 0) {
      // Check if modifiers or POS changed
      const originalMods = String(deniedClaim.modifiers || '');
      const originalPOS = String(deniedClaim.place_of_service || '');
      
      rebills.forEach(rebill => {
        const rebillMods = String(rebill.modifiers || '');
        const rebillPOS = String(rebill.place_of_service || '');
        
        if (rebillMods !== originalMods || rebillPOS !== originalPOS) {
          rebillChains.push({
            denied: deniedClaim,
            rebilled: rebill,
            changed: {
              modifiers: rebillMods !== originalMods,
              pos: rebillPOS !== originalPOS
            }
          });
        }
      });
    }
  });
  
  if (rebillChains.length < 8) return null; // Threshold: ≥8 chains
  
  console.log(`[Denial-Exploits] Provider ${providerId}: ${rebillChains.length} denial-rebill chains`);
  
  const avgAmount = rebillChains.reduce((sum, chain) => 
    sum + parseFloat(chain.rebilled.billed_amount), 0
  ) / rebillChains.length;
  const exposure = rebillChains.length * avgAmount * 0.4;
  
  return {
    rule_id: 'DME-C-003',
    rule_name: 'Denial Pattern Exploits',
    tier: 'C',
    severity: 'low',
    description: `${rebillChains.length} denied claims successfully rebilled with modifier/POS changes`,
    evidence: {
      affected_members: new Set(rebillChains.map(c => c.denied.member_id)).size,
      affected_claims: rebillChains.length,
      total_exposure: Math.round(exposure),
      violation_rate: `${rebillChains.length} rebill chains`,
      expected_threshold: '<5 chains per quarter',
      peer_percentile: 90,
      exemplar_claims: rebillChains.flatMap(c => [c.denied, c.rebilled]).slice(0, 20)
    },
    weight: 0.4
  };
}
